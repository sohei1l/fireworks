<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Neon Particles</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        background: black;
        overflow: hidden;
        font-family: Arial, sans-serif;
      }

      #canvas {
        display: block;
        width: 100vw;
        height: 100vh;
      }

      #header {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        text-align: center;
        z-index: 100;
      }

      #project-title {
        color: #000000;
        font-size: 24px;
        font-weight: bold;
        margin: 0 0 8px 0;
        /* text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); */
      }

      #github-link {
        color: #000;
        font-size: 14px;
        text-decoration: none;
        margin-bottom: 15px;
        display: inline-block;
        transition: color 0.3s ease;
      }

      #github-link:hover {
        color: #ffffff;
      }

      #instructions {
        color: #000000;
        font-size: 18px;
        font-weight: bold;
        margin-top: 10px;
        /* background: rgba(255, 255, 255, 0.9); */
        padding: 0px;
        border-radius: 8px;
        /* box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); */
      }

      #instructions p {
        margin: 0;
        font-weight: lighter;
      }

      #fps {
        position: absolute;
        top: 10px;
        left: 10px;
        color: #00ff00;
        font-size: 14px;
        z-index: 100;
        background: rgba(0, 0, 0, 0.6);
        padding: 4px 8px;
        border-radius: 4px;
      }

      #controls {
        position: absolute;
        top: 10px;
        right: 10px;
        color: #161414;
        font-size: 14px;
        z-index: 100;
        background: rgba(0, 0, 0, 0.85);
        padding: 15px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
        min-width: 200px;
      }

      #controls h3 {
        margin: 0 0 10px 0;
        color: #00ffff;
        font-size: 16px;
        text-align: center;
      }

      #controls label {
        display: block;
        margin: 8px 0;
        cursor: pointer;
        transition: color 0.3s ease;
        color: #ffffff;
      }

      #controls label:hover {
        color: #00ffff;
      }

      #controls input[type="checkbox"] {
        margin-right: 8px;
        transform: scale(1.2);
      }

      #controls input[type="range"] {
        width: 120px;
        margin-left: 8px;
      }

      #friction-value {
        color: #00ff00;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>

    <div id="header">
      <h1 id="project-title">Neon Particles</h1>
      <a
        href="https://github.com/sohei1l/neon-particles"
        target="_blank"
        id="github-link"
      >
        https://github.com/sohei1l/neon-particles
      </a>
      <div id="instructions">
        <p>Click anywhere on Canvas</p>
        <p>to spawn particles.</p>
      </div>
    </div>

    <div id="fps">FPS: --</div>

    <div id="controls">
      <h3>Controls</h3>
      <label>
        <input type="checkbox" id="gravity-toggle" checked /> Gravity
      </label>
      <label>
        <input type="checkbox" id="bloom-toggle" checked /> Bloom Effect
      </label>
      <label>
        <input type="checkbox" id="trails-toggle" checked /> Particle Trails
      </label>
      <label>
        Friction:
        <input
          type="range"
          id="friction-slider"
          min="0.9"
          max="1.0"
          step="0.01"
          value="0.95"
        />
        <span id="friction-value">0.95</span>
      </label>
    </div>

    <script type="module">
      async function run() {
        try {
          console.log("Loading WASM module...");
          const { default: init, App } = await import(
            "./pkg/neon_particles.js"
          );
          console.log("WASM module loaded, initializing...");

          await init();
          console.log("WASM initialized, setting up canvas...");

          const canvas = document.getElementById("canvas");
          console.log("Canvas element:", canvas);

          // Set canvas size BEFORE creating the App
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
          console.log("Canvas size set to:", canvas.width, "x", canvas.height);

          console.log("Creating app...");
          const app = new App();
          console.log("App created successfully");

          // Add mouse click event listener
          canvas.addEventListener("click", (event) => {
            try {
              const rect = canvas.getBoundingClientRect();
              const x = event.clientX - rect.left;
              const y = event.clientY - rect.top;

              // Scale to canvas internal coordinates
              const scaleX = canvas.width / rect.width;
              const scaleY = canvas.height / rect.height;

              console.log("Spawning particles at:", x * scaleX, y * scaleY);
              app.spawn_particles(x * scaleX, y * scaleY);
            } catch (e) {
              console.error("Error spawning particles:", e);
            }
          });

          // Add control event listeners
          const gravityToggle = document.getElementById("gravity-toggle");

          // Set initial gravity state to match app default
          app.set_gravity(true);

          gravityToggle.addEventListener("change", (event) => {
            try {
              app.set_gravity(event.target.checked);
              console.log("Gravity set to:", event.target.checked);
            } catch (e) {
              console.error("Error setting gravity:", e);
            }
          });

          const bloomToggle = document.getElementById("bloom-toggle");
          bloomToggle.addEventListener("change", (event) => {
            try {
              app.set_bloom(event.target.checked);
              console.log("Bloom set to:", event.target.checked);
            } catch (e) {
              console.error("Error setting bloom:", e);
            }
          });

          const trailsToggle = document.getElementById("trails-toggle");
          trailsToggle.addEventListener("change", (event) => {
            try {
              app.set_trails(event.target.checked);
              console.log("Trails set to:", event.target.checked);
            } catch (e) {
              console.error("Error setting trails:", e);
            }
          });

          const frictionSlider = document.getElementById("friction-slider");
          const frictionValue = document.getElementById("friction-value");

          // Set initial friction value to match the app default
          app.set_friction(0.95);

          frictionSlider.addEventListener("input", (event) => {
            try {
              const value = parseFloat(event.target.value);
              app.set_friction(value);
              frictionValue.textContent = value.toFixed(2);
              console.log("Friction set to:", value);
            } catch (e) {
              console.error("Error setting friction:", e);
            }
          });

          console.log("Starting render loop...");
          let frameCount = 0;
          let lastTime = 0;
          const fpsElement = document.getElementById("fps");

          function frame(time) {
            try {
              app.render(time);

              // Update FPS display every 60 frames
              frameCount++;
              if (frameCount % 60 === 0) {
                if (lastTime > 0) {
                  const fps = 60000 / (time - lastTime);
                  fpsElement.textContent = `FPS: ${fps.toFixed(1)}`;
                }
                lastTime = time;
              }

              requestAnimationFrame(frame);
            } catch (e) {
              console.error("Error in render loop:", e);
              fpsElement.textContent = "FPS: ERROR";
            }
          }

          requestAnimationFrame(frame);
          console.log("Application started successfully");
        } catch (error) {
          console.error("Failed to initialize application:", error);
          document.body.innerHTML += `<div style="color: red; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;">
                    <h2>Error Loading Application</h2>
                    <p>${error.message}</p>
                    <p>Check browser console for more details.</p>
                </div>`;
        }
      }

      run();
    </script>
  </body>
</html>
