<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Magic Brush</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        background: black;
        overflow: hidden;
        font-family: Arial, sans-serif;
      }

      #canvas {
        display: block;
        width: 100vw;
        height: 100vh;
      }

      #header {
        position: absolute;
        top: 20px;
        left: 20px;
        text-align: left;
        z-index: 100;
      }

      #project-title {
        color: #888888;
        font-size: 24px;
        font-weight: bold;
        margin: 0 0 8px 0;
        /* text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); */
      }

      #github-link {
        color: #888888;
        font-size: 14px;
        text-decoration: none;
        margin-bottom: 15px;
        display: inline-block;
        transition: color 0.3s ease;
      }

      #github-link:hover {
        color: #ffffff;
      }

      #instructions {
        color: #000000;
        font-size: 18px;
        font-weight: bold;
        margin-top: 10px;
        /* background: rgba(255, 255, 255, 0.9); */
        padding: 0px;
        border-radius: 8px;
        /* box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); */
      }

      #instructions p {
        margin: 0;
        font-weight: lighter;
      }

      #fps {
        color: #cccccc;
        font-size: 12px;
        margin-top: 8px;
        text-align: center;
      }

    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>

    <div id="header">
      <h1 id="project-title">Magic Brush</h1>
      <a
        href="https://github.com/sohei1l/magic-brush"
        target="_blank"
        id="github-link"
      >
        https://github.com/sohei1l/magic-brush
      </a>
    </div>


    <script type="module">
      async function run() {
        try {
          console.log("Loading WASM module...");
          const { default: init, App } = await import(
            "./pkg/neon_particles.js"
          );
          console.log("WASM module loaded, initializing...");

          await init();
          console.log("WASM initialized, setting up canvas...");

          const canvas = document.getElementById("canvas");
          console.log("Canvas element:", canvas);

          // Set canvas size BEFORE creating the App
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
          console.log("Canvas size set to:", canvas.width, "x", canvas.height);

          console.log("Creating app...");
          const app = new App();
          console.log("App created successfully");

          // Add mouse click event listener
          canvas.addEventListener("click", (event) => {
            try {
              const rect = canvas.getBoundingClientRect();
              const x = event.clientX - rect.left;
              const y = event.clientY - rect.top;

              // Scale to canvas internal coordinates
              const scaleX = canvas.width / rect.width;
              const scaleY = canvas.height / rect.height;

              console.log("Spawning particles at:", x * scaleX, y * scaleY);
              app.spawn_particles(x * scaleX, y * scaleY, performance.now());
            } catch (e) {
              console.error("Error spawning particles:", e);
            }
          });

          // Magic brush is always enabled
          let isTouching = false; // Track if user is touching for mobile

          canvas.addEventListener("mousemove", (event) => {
            try {
              const rect = canvas.getBoundingClientRect();
              const x = event.clientX - rect.left;
              const y = event.clientY - rect.top;

              // Scale to canvas internal coordinates
              const scaleX = canvas.width / rect.width;
              const scaleY = canvas.height / rect.height;

              app.spawn_magic_brush_particles(x * scaleX, y * scaleY, performance.now());
            } catch (e) {
              console.error("Error with magic brush:", e);
            }
          });

          // Add touch events for mobile support
          canvas.addEventListener("touchstart", (event) => {
            try {
              event.preventDefault(); // Prevent scrolling
              isTouching = true;

              const rect = canvas.getBoundingClientRect();
              const touch = event.touches[0];
              const x = touch.clientX - rect.left;
              const y = touch.clientY - rect.top;

              // Scale to canvas internal coordinates
              const scaleX = canvas.width / rect.width;
              const scaleY = canvas.height / rect.height;

              app.spawn_magic_brush_particles(x * scaleX, y * scaleY, performance.now());
            } catch (e) {
              console.error("Error with touch start:", e);
            }
          });

          canvas.addEventListener("touchmove", (event) => {
            try {
              event.preventDefault(); // Prevent scrolling

              if (isTouching) {
                const rect = canvas.getBoundingClientRect();
                const touch = event.touches[0];
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;

                // Scale to canvas internal coordinates
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;

                app.spawn_magic_brush_particles(x * scaleX, y * scaleY, performance.now());
              }
            } catch (e) {
              console.error("Error with touch move:", e);
            }
          });

          canvas.addEventListener("touchend", (event) => {
            try {
              event.preventDefault();
              isTouching = false;
            } catch (e) {
              console.error("Error with touch end:", e);
            }
          });

          canvas.addEventListener("touchcancel", (event) => {
            try {
              event.preventDefault();
              isTouching = false;
            } catch (e) {
              console.error("Error with touch cancel:", e);
            }
          });

          // Set app defaults - all features optimized for magic brush writing
          app.set_gravity(false);
          app.set_bloom(true);
          app.set_trails(true);
          app.set_friction(0.95);
          
          // Set cursor for magic brush
          canvas.style.cursor = "crosshair";

          console.log("Starting render loop...");

          function frame(time) {
            try {
              app.render(time);
              requestAnimationFrame(frame);
            } catch (e) {
              console.error("Error in render loop:", e);
            }
          }

          requestAnimationFrame(frame);
          console.log("Application started successfully");
        } catch (error) {
          console.error("Failed to initialize application:", error);
          document.body.innerHTML += `<div style="color: red; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;">
                    <h2>Error Loading Application</h2>
                    <p>${error.message}</p>
                    <p>Check browser console for more details.</p>
                </div>`;
        }
      }

      run();
    </script>
  </body>
</html>
